{% extends 'base.html.twig' %}

{% block title %}Hello CategoryController!
{% endblock %}

{% block body %}

	{% include 'front/category/partials/_menu.html.twig' %}
	<link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css"/>
	<section class="fluid-container">
		<div class="row">
			{% include 'front/category/partials/_map.html.twig' %}
			{% include 'front/category/partials/_listing.html.twig' %}
		</div>
	</section>

	<script>
		// Toggle save button
		document.querySelectorAll('.save-btn').forEach(button => {
			button.addEventListener('click', function (e) {
				e.preventDefault();
				const icon = this.querySelector('i');
				if (icon.classList.contains('bi-heart')) {
					icon.classList.remove('bi-heart');
					icon.classList.add('bi-heart-fill', 'text-danger');
				} else {
					icon.classList.remove('bi-heart-fill', 'text-danger');
					icon.classList.add('bi-heart');
				}
			});
		});

		// Filter chips toggle
		document.querySelectorAll('.filter-chip').forEach(chip => {
			chip.addEventListener('click', function () {
				document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
				this.classList.add('active');
			});
		});

		// Bedroom buttons toggle
		document.querySelectorAll('.btn-outline-primary.btn-sm').forEach(btn => {
			btn.addEventListener('click', function () {
				if (!this.classList.contains('all-btn')) {
					document.querySelectorAll('.btn-outline-primary.btn-sm').forEach(b => b.classList.remove('active'));
					this.classList.add('active');
				}
			});
		});

		// Initialize tooltips
		var tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
		var tooltipList = tooltipTriggerList.map(function (tooltipTriggerEl) {
			return new bootstrap.Tooltip(tooltipTriggerEl);
		});
	</script>


	<script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
	<script>
		const properties = [{% for property in properties %}
				{
					id: {{ property.id }},
					title: "{{ property.title|e('js') }}",
					description: "{{ property.description|striptags|e('js') }}",
					type: "{{ property.propertyType.value|e('js') }}",
					transaction: "{{ property.transactionType.value|e('js') }}",
					price: "{{ property.price|number_format(0, '.', ' ') }}€",
					address: "{{ property.address|e('js') }},  {{ property.postalCode|e('js') }}{{ property.city|e('js') }}",
					latitude: {{ property.latitude|default(48.8566) }},
					longitude: {{ property.longitude|default(2.3522) }}
				},{% endfor %}];

		// Valeurs par défaut
		const defaultZoom = 12;

		// Lire lat/lng/zoom depuis l'URL si existants
		const urlParams = new URLSearchParams(window.location.search);
		const latParam = parseFloat(urlParams.get('lat'));
		const lngParam = parseFloat(urlParams.get('lng'));
		const zoomParam = parseInt(urlParams.get('zoom')) || defaultZoom;

		let mapCenter = [48.8566, 2.3522]; // Paris par défaut
		if (!isNaN(latParam) && !isNaN(lngParam)) {
			mapCenter = [latParam, lngParam];
		}

		const map = L.map('map').setView(mapCenter, zoomParam);

		L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {attribution: '&copy; OpenStreetMap contributors'}).addTo(map);

		const markers = [];

		properties.forEach(property => {
			if (property.latitude && property.longitude) {
				const marker = L.marker([property.latitude, property.longitude]).addTo(map);

				const detailUrl = `/property/detail?id=${
					property.id
				}&lat=${
					property.latitude
				}&lng=${
					property.longitude
				}`;

				const popupContent = `
	                <div class="popup-content">
	                    <b>${
					property.title
				}</b>
	                    <i>${
					property.type
				} - ${
					property.transaction
				}</i>
	                    <hr>
	                    <div><b>Prix :</b> ${
					property.price
				}</div>
	                    <div><b>Adresse :</b> ${
					property.address
				}</div>
	                    <div>${
					property.description.substring(0, 100)
				}...</div>
	                    <a href="${detailUrl}" target="_blank">Voir le détail</a>
	                </div>
	            `;

				marker.bindPopup(popupContent);

				markers.push(marker);
			}
		});

		// Ajuster la vue pour inclure tous les marqueurs
		if (markers.length > 0) {
			const group = L.featureGroup(markers);
			map.fitBounds(group.getBounds().pad(0.2));
		}

		// Mettre à jour l'URL quand l'utilisateur bouge ou zoome
		map.on('moveend zoomend', function () {
			const center = map.getCenter();
			const zoom = map.getZoom();
			const newUrl = `${
				window.location.pathname
			}?lat=${
				center.lat.toFixed(6)
			}&lng=${
				center.lng.toFixed(6)
			}&zoom=${zoom}`;
			window.history.replaceState({}, '', newUrl);
		});
	</script>


{% endblock %}
